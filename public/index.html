<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Codeshare</title>
    <style>
      body {
        background: #0d1117;
        color: #c9d1d9;
        font-family: monospace;
        margin: 0;
        display: flex;
        height: 100vh;
      }
      .sidebar {
        width: 250px;
        background-color: #161b22;
        border-right: 1px solid #30363d;
        padding: 1em;
        overflow-y: auto;
      }
      .sidebar h2 {
        font-size: 1em;
        margin-top: 0;
      }
      .sidebar ul {
        list-style: none;
        padding-left: 0;
      }
      .sidebar li {
        cursor: pointer;
        padding: 6px 8px;
        border-radius: 4px;
      }
      .sidebar li:hover,
      .sidebar li.active {
        background-color: #238636;
        color: white;
      }
      .main {
        flex: 1;
        padding: 1.5em;
        display: flex;
        flex-direction: column;
      }
      h1 {
        font-size: 1.2em;
        margin-bottom: 0.5em;
      }
      .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5em;
      }
      button {
        background-color: #238636;
        border: none;
        color: white;
        padding: 6px 12px;
        font-size: 0.9em;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #2ea043;
      }

      /* Estilos para o Ace Editor */
      #editor {
        flex: 1;
        height: 100%;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <h2>Arquivos</h2>
      <ul id="file-list">
        <li>Nenhum arquivo</li>
      </ul>
    </div>
    <div class="main">
      <div class="toolbar">
        <h1 id="file-name">Nenhum arquivo salvo</h1>
        <button id="copy-btn">Copiar código</button>
      </div>
      <div id="editor">// aguardando código salvo...</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ext-modelist.js"></script>

    <script>
      const fileList = document.getElementById("file-list");
      const fileNameEl = document.getElementById("file-name");
      const copyBtn = document.getElementById("copy-btn");

      const files = new Map();
      let activeFilename = "";

      const socket = new WebSocket(`ws://${location.host}`);

      // Configuração do Ace Editor
      const editor = ace.edit("editor");
      editor.setTheme("ace/theme/tomorrow_night_eighties"); // Ou "monokai", "github", etc.
      editor.setOptions({
        fontSize: "16px",
        readOnly: true, // O código não pode ser editado no navegador
      });

      const modelist = ace.require("ace/ext/modelist");

      socket.onopen = () => {
        socket.send(JSON.stringify({ type: "request_sync" }));
      };

      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          const { type, filename, content, language } = data;

          if (type === "open" || type === "content") {
            files.set(filename, {
              language,
              code: content,
            });
            updateFileList();
            if (activeFilename === "" || activeFilename === filename) {
              showFile(filename);
            }
          } else if (type === "patch") {
            const file = files.get(data.filename) || {};
            files.set(data.filename, {
              ...file,
              code: data.content,
              language: data.language,
            });
            updateFileList();
            showFile(data.filename);
          } else if (type === "selection") {
            if (
              data.selection.start.row === data.selection.end.row &&
              data.selection.start.col === data.selection.end.col
            )
              return;
            if (activeFilename === filename) {
              selectText(
                data.selection.start.row,
                data.selection.start.col,
                data.selection.end.row,
                data.selection.end.col
              );
            }
          } else if (type === "close") {
            files.delete(filename);
            if (filename === activeFilename) {
              activeFilename = "";
              fileNameEl.textContent = "Nenhum arquivo salvo";
              editor.setValue("// aguardando código salvo...", -1);
            }
            updateFileList();
          }
        } catch (err) {
          console.error("Erro ao processar payload:", err);
        }
      };

      function selectText(startRow, startColumn, endRow, endColumn) {
        const range = new ace.Range(startRow, startColumn, endRow, endColumn);
        editor.getSelection().setSelectionRange(range);
      }

      function updateFileList() {
        fileList.innerHTML = "";
        for (const [filename] of files.entries()) {
          const li = document.createElement("li");
          li.textContent = filename;
          li.className = filename === activeFilename ? "active" : "";
          li.onclick = () => showFile(filename);
          fileList.appendChild(li);
        }
      }

      function showFile(filename) {
        const data = files.get(filename);
        if (!data) return;

        activeFilename = filename;
        updateFileList();

        fileNameEl.textContent = filename;

        const mode = modelist.getModeForPath(filename).mode;
        editor.session.setMode(mode);
        editor.setValue(data.code, -1);
      }

      function copiarCodigo() {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(editor.getValue())
            .then(() => alert("Código copiado."))
            .catch((err) => alert("Erro ao copiar: " + err));
        } else {
          const textarea = document.createElement("textarea");
          textarea.value = editor.getValue();
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand("copy");
            alert("Código copiado.");
          } catch (err) {
            alert("Erro ao copiar: " + err);
          }
          document.body.removeChild(textarea);
        }
      }

      copyBtn.addEventListener("click", copiarCodigo);
    </script>
  </body>
</html>
